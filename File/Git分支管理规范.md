# Git分支管理规范

## 0. 前言

本分支管理规范借鉴了目前Git Flow工作流分支管理的思想，并结合项目实际情况对其进行了简化。

结合实际落地经验，该分支管理模式在具有以下特点的场景能良好地实施，且维护成本较低：

- 版本单向迭代，且不关注历史版本
- 版本迭代周期短（单版本周期<=20天）
- 团队人数较少（单模块开发人数<=5人）
- 并行版本少（最大并行版本数<=3）



## 1. 概述

### 1.1 分支分类

- **Master**：主干分支
- **Local**：本地开发分支
- **Dev**：联调开发分支
- **Release**：提测分支
- **Hotfix**：紧急修复分支



### 1.2 常规版本开发流程

![Git-branch-flow](https://github.com/Sunxiai51/Note/blob/master/File/Image/Git-branch-flow.png)

1. 基于**Master**拉取**Local**开始开发。
2. 开发完成后，基于**Master**拉取**Dev**，并将**Local**合并入**Dev**，同时删除**Local**。进入联调阶段。
3. 联调过程中，需要修改可以基于**Dev**拉取临时分支，修改后合并入**Dev**，同时删除临时分支。如果改动较小也可以直接提交至**Dev**。
4. 联调完成后，基于**Master**拉取**Release**，并将**Dev**合并入**Release**，同时删除**Dev**。进入测试阶段。
5. 测试过程中，需要修改可以基于**Release**拉取临时分支，修改后合并入**Release**，同时删除临时分支。如果改动较小也可以直接提交至**Release**。
6. 测试过程中，如果**Master**发生任何变化，需要从**Master**合并入**Release**。
7. 测试完成后，进入发布阶段。
8. 发布完成后，**Release**合并入**Master**，同时删除**Release**。



### 1.3 持续集成工作流

![CI-work-flow](https://github.com/Sunxiai51/Note/blob/master/File/Image/CI-work-flow.png)



## 2. 细则

### 2.1 主干分支

代码库有且仅有一个主干分支，该分支长期存在，**其代码始终和生产版本保持一致**。

命名固定为`master`。

> 该分支用于维护生产版本最新代码，这样是为了保证在协作开发过程中，任何基于master拉出的分支都包含了当前生产环境的所有代码。
>
> 通常情况下，该分支不会用于打包发布。

相关规则：

- 所有新分支都应该基于master创建
- master分支应该设置为受保护，仅接受merge，且仅**模块负责人**具有merge权限
- 生产环境代码被更新后，必须第一时间将发布分支合并至master，以确保一致
- 当master代码发生变化时，进行合并的**模块负责人**应检查该模块是否存在其它**Release**，如存在，需知会其**版本负责人**

> 模块负责人：通常是指最熟悉该模块代码，且长期参与该模块的开发维护人员，可以有一至多个，建议指定多个。
>
> 版本负责人：见 2.4 提测分支



### 2.2 本地开发分支

本地开发分支仅存在于本地，一般不会push到代码库，故没有制订相关命名规范，根据个人习惯进行命名即可。

如果实在需要将本地开发分支push至代码库（例如完成了某些开发内容，但短期内不会上线，为避免代码丢失而推送至代码库的场景），分支名需要具有以下特征：

- 可识别，不会与已有命名规则混淆
- 能识别提交者身份
- 能大概表述提交内容

例如：`temp-wuyiyang-logprint-upgrade`

尽管如此，我们仍然应该**尽可能避免将本地开发分支push至代码库**，因为这会增加代码库中分支数量，在发布前的检查和分支合并时可能会带来一些麻烦，为误操作留下隐患，提高了维护成本。



### 2.3 联调开发分支

联调开发分支在联调阶段存在于代码库，用于在联调阶段汇总各成员本地开发分支，并部署到开发环境进行联调。

命名规则为`dev/{版本号}`。

> 注意：联调阶段不是必须的。联调往往是在跨模块的功能开发完成后，为了保证提测质量而进行的一次开发环境的测试。对于某些改动较小，功能比较单一的版本，如果开发评估本地单测足以覆盖用例，也可以跳过联调阶段直接提测，此时不需要拉取**Dev**，而是直接拉取**Release**，并将**Local**合并入**Dev**，同时删除**Local**。

> 另外，关于将**Local**合并至**Dev**或**Release**时，有一个关于整洁性的小建议，即将**Local**中同一个开发人员对于同一功能的多次提交rebase为一次提交后再进行合并。这样的好处是后续master中的历史提交记录会比较整洁，可读性更强。



### 2.4 提测分支

提测分支在测试阶段存在于代码库，由**版本负责人**在提测前统一基于master创建，用于测试和发布。

> 版本负责人：为每一个版本指定一个版本负责人，通常为熟悉该版本全部功能与代码修改范围的开发人员，一般一个版本仅有一个版本负责人。该角色负责创建release分支，并对该版本产生的所有修改负责，包括code review，发布后的合并等。

命名规则为`release/{版本号}`。

相关规则：

- 该分支应该设置为受保护的，仅**版本负责人**具有merge与push权限（实际应用中，如果某个大版本改动很大，往往也会给**模块负责人**分配merge权限来分担code review工作）
- 该分支于测试阶段发生任何改动都需要重新打包部署至测试环境，并知会测试人员改动内容
- 该分支落后于主干分支时无法测试通过
- 测试通过后该分支不应再接受任何修改
- 发布至生产环境后，**版本负责人**应该在第一时间发起该提测分支的merge请求，并于功能稳定后知会各**模块负责人**进行合并



### 2.5 紧急修复分支

紧急修复分支用于修复生产环境中的bug。

命名规则为`hotfix/{修复内容简单描述}`，例如：`hotfix/file-upload-oom-fix`。

紧急修复流程如下：

1. **修复人员**基于master创建**Hotfix**，开始开发
2. 开发完成后直接基于该分支打包，部署至测试环境由测试人员测试（如有必要）
3. 测试通过后，由**修复人员**提交merge请求至**Master**，并知会**模块负责人**进行code review
4. Code review通过后，由**修复人员**发布至生产环境，并于功能稳定后知会**模块负责人**进行合并

由于该分支往往改动内容不多且只有少量提交者，基本不存在分支合并的问题，故不需要特别指定其保护权限。且生产环境问题往往较为紧急，该分支存在时间不会很长，基本不会造成长期影响。

> 紧急修复流程仅适用于bug影响比较严重且修改量较少的情况。如果bug不紧急则不建议执行紧急修复流程，而是放到下一个版本中修复。如果bug影响严重且经开发评估改动量很大，仍然不建议执行紧急修复流程，这种情况下通常的做法是：先回滚至上一个稳定版本（如果可以），然后单独拉出一个最高优先级的问题修复版本，按照常规版本流程执行。



